#!/bin/bash

# Detect main branch name (main/master) from git
function get_main_branch()
{
  # Try to get the symbolic ref for origin/HEAD
  local ref
  ref=$(git symbolic-ref --quiet refs/remotes/origin/HEAD 2>/dev/null)
  if [ $? -eq 0 ] && [[ $ref =~ refs/remotes/origin/(.*) ]]; then
    echo "${BASH_REMATCH[1]}"
    return
  fi
  # Fallback: check for local branches
  if git show-ref --verify --quiet refs/heads/main; then
    echo "main"
    return
  fi
  if git show-ref --verify --quiet refs/heads/master; then
    echo "master"
    return
  fi
  # Default fallback
  echo "main"
}

## Abort if there are any uncommitted changes (staged or unstaged)
function abort_if_uncommitted_changes()
{
  if [[ -n $(git status --porcelain) ]]; then
    echo "Error: Uncommitted changes detected in current branch. Please commit or stash them before running this script."
    exit 1
  fi

  local current_branch
  current_branch=$(git rev-parse --abbrev-ref HEAD)
  local branches=("develop" "$(get_main_branch)")
  for branch in "${branches[@]}"; do
    git checkout "$branch" >/dev/null 2>&1
    if [[ -n $(git status --porcelain) ]]; then
      echo "Error: Uncommitted changes detected in $branch. Please commit or stash them before running this script."
      exit 1
    fi
  done
  git checkout "$current_branch" >/dev/null 2>&1
}

# Detects the environment: rails, php, python, or unknown
function detect_environment()
{
  if [ -f "Gemfile" ] && grep -q "rspec" Gemfile.lock 2>/dev/null; then
    echo "rails"
  elif [ -f "composer.json" ] && [ -d "vendor" ]; then
    echo "php"
  elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
    echo "python"
  else
    echo "unknown"
  fi
}

# Run the tests for the detected environment.
function run_tests()
{
  ENVIRONMENT=$(detect_environment)
  echo "Detected environment: $ENVIRONMENT"

  case "$ENVIRONMENT" in
    rails)
      echo "Running Rails (RSpec) tests..."
      bundle exec rspec || { echo "RSpec tests failed"; exit 1; }
      ;;
    php)
      echo "Running PHP (PHPUnit) tests..."
      ./vendor/bin/phpunit tests || { echo "PHPUnit tests failed"; exit 1; }
      ;;
    python)
      echo "Running Python tests..."
      if [ -f "pytest.ini" ] || [ -d "tests" ]; then
          pytest || { echo "pytest tests failed"; exit 1; }
      else
          python -m unittest discover || { echo "unittest tests failed"; exit 1; }
      fi
      ;;
    *)
      echo "Could not find tests. Skipping.."
      ;;
  esac
}

# Start the hotfix from main/master using the bumped patch version.
function git_hotfix_start()
{
  echo "Starting hotfix on $BRANCH..."
  git checkout "$BRANCH"
  git pull
  bump -p | xargs git flow hotfix start || { echo "git flow hotfix start failed"; exit 1; }
}

# Finish the hotfix, update versionlog, and push changes.
function git_hotfix_finish()
{
  echo "Preparing hotfix $(bump)..."

  if $SKIP_TESTS; then
    echo "Skipping test execution."
  else
    run_tests
  fi

  if [ "$STRATEGY" = "semver" ]; then
    DATE=$(date +"%Y-%m-%d")
    awk -v date="$DATE" '/^## [0-9]+\.[0-9]+\.[0-9]+$/ && !added { print $0, date; added=1; next } 1' versionlog.md > tmpfile && mv tmpfile versionlog.md
  else
    VERSION=$(bump)
    echo -e "## $VERSION\n\n$(cat versionlog.md)" > versionlog.md
  fi

  git commit -am "Updated versionlog.md" --no-verify
  export GIT_MERGE_AUTOEDIT=no
  git flow hotfix finish -m "hotfix" -m "hotfix"

  git checkout "$BRANCH"
  git push
  git push --tags
  git checkout develop
  git push
}

abort_if_uncommitted_changes
set -e  # Exit immediately if a command fails
set -o pipefail  # Exit on failure in piped commands

SKIP_TESTS=false  # Default behavior: run tests

version_file=".version.json"

if ! [ -f "$version_file" ]; then
  echo "Error: $version_file not found."
  exit 1
fi

STRATEGY=$(jq -r '.strategy' .version.json)

if [ -z "$STRATEGY" ]; then
  echo "Missing strategy. Defaulting to 'semver'"
  STRATEGY="semver"
fi

MODE=""

for arg in "$@"; do
  if [[ "$arg" == "--skip-tests" ]]; then
    SKIP_TESTS=true
    echo "Skipping tests."
  fi

  if [[ "$arg" == "--show-environment" ]]; then
    detect_environment
    exit
  fi

  if [[ "$arg" == --branch=* ]]; then
    BRANCH="${arg#--branch=}"
  fi

  if [[ "$arg" == "--start" ]]; then
    MODE="start"
  fi

  if [[ "$arg" == "--finish" ]]; then
    MODE="finish"
  fi
done

if [ -z "$MODE" ]; then
  echo "Error: Must provide --start or --finish"
  exit 1
fi

if [ "$MODE" = "start" ] && $SKIP_TESTS; then
  echo "Note: --skip-tests is only used for --finish."
fi

BRANCH="${BRANCH:-$(get_main_branch)}"

echo "do_hotfix v1.0"
echo "Branch: $BRANCH"
echo "Strategy: $STRATEGY"

if [ "$MODE" = "start" ]; then
  git_hotfix_start
elif [ "$MODE" = "finish" ]; then
  if ! [ -f "versionlog.md" ]; then
    echo "Error: versionlog.md not found."
    exit 1
  fi
  git_hotfix_finish
else
  echo "Error: Unknown mode $MODE"
  exit 1
fi
